# What does this do?

This is a pre-made docker compose file which uses the "certbot/certbot" image to generate/renew SSL Certificates for HTTPS using Let's Encrypt. It also contains 2 scripts written in Python that are used to connect with the Cloudflare API, save the DNS challenges and then clean them once everything is complete.

# How to use it?

First you must have the latest versions of Docker and Docker Compose installed on your server, then clone or download the whole repo.

After that, you must edit the "docker-compose.yaml" file and change the path where your certificates will be created, or if you already have Let's Encrypt Certificates, then write the path where they already exist (usually in "/etc/letsencrypt")

The compose file has the certbot command ready to generate wilcard certificates for your domain, if you need to create certificates for other sub-domains using the DNS challenge, change the "-d" portions of the command to what you need.

Once everything is configured in the compose file, you need to copy the ".env.example" file into a new file called ".env", inside there you'll need to provide some data in order for the scripts to work.

### CERTBOT_CMD_DOMAIN

This environment variable will hold the domain you purchased/own for which you want to generate the certificates.

**NOTE:** The environment variable is called "CMD_DOMAIN" because it's the domain that is used in the command, it's also called this way to tell it apart from the "CERTBOT_DOMAIN" variable generated by the certbot command.

### CERTBOT_EMAIL

This environment variable will hold the email you use for the certificate generation/renewal process. It's also the email you use in your Cloudflare account.

### CERTBOT_SERVER

This variable will hold the Let's Encrypt server to use for the generation/renewal of the certificates. By default it uses "https://acme-v02.api.letsencrypt.org/directory"

### CERTBOT_ZONE_ID

This variable will hold the Zone ID that's generated by Cloudflare. To get this ID, you need to log in the Cloudflare Dashboard and find you zone corresponding to you domain, there you'll find the Zone ID.

### CERTBOT_BEARER_TOKEN

This variable will hold the API Token that you can generate in Cloudflare. However, this is an optional variable since the API can work with the API Key and your email.

### CERTBOT_API_KEY

This environment variable will hold the API Key from Cloudflare to use when the script needs to register/clean the challenges. It can be obtained from Cloudflare if you log in the Cloudflare Dashboard, find your zone corresponding to your domain, scroll down to "Get your API token", then scroll down to "API Keys", and in "Global API Key", click on "View", type your password and enter the captcha, and clicking "View" one more time, your API Key will show up.

After all environment variables are set properly, type "docker-compose run --rm certbot" and wait for the process to finish. The hook will wait 60 seconds for every challenge registered on your DNS, so if you only wanted to generate a certificate for your root domain or just the wildcard, the process will take a little bit more than 1 minute, however, if instead of the wildcard certificate you requested a certificate for multiple sub-domains, expect the process to last longer.

### LETSENCRYPT_FOLDER (Added 24-07-2023)

This environment variable will hold the location of the Let's Encrypt files stored in your server. This variable was added since previously the file docker-compose.yaml had to be modified after pulling the project from GitHub, and the local Git would detect that as a modification. By default this variable's value is "/etc/letsencrypt", since this is the usual location of the files, but it should be changed to the actual location of the files and certificates. DO NOT leave this variable empty as it will throw errors from Docker Compose.

# What to do next?

After the certificates are generated, the container running the command will be removed (unless you forgot the "--rm" argument) and any temporary file will be removed. Then you can reload or restart any service using HTTPS that also uses the generated certificate, or just change the configuration of those services so they can use the certificates.

# Do I have to run this manually everytime I need to renew my certificate?

No. This is the main reason why it was made. Probably most people prefer generating a wildcard certificate rather than one or more certificates for different sets of sub-domains, however, it is quite the pain having to manually create TXT records to renew the certificate, and since Cloudflare is the DNS service I use personally and in my work, and also because up to this date this is the only DNS service that has an API Rest capable of managing a user's DNS (that I know of), I decided to create a script that can automatically create TXT records with the data provided by certbot. And I also decided to containerize it with Docker and simplify it with Docker Compose so that the final command is simple.

# OK, so can I create a cron with this?

Yes, but you will have to specify the location of the docker-compose.yaml file on the command. Also, you will have to be responsible for the reloading/restarting of your services using HTTPS.
